sudo apt update
sudo apt install hostapd

sudo nano /etc/NetworkManager/NetworkManager.conf
[keyfile]
unmanaged-devices=interface-name:wlan0

sudo systemctl unmask hostapd
sudo systemctl enable hostapd
sudo systemctl start hostapd

sudo apt update
sudo apt install dnsmasq

sudo nano /etc/network/interfaces.d/wlan0
auto wlan0
iface wlan0 inet static
    address 192.168.4.1
    netmask 255.255.255.0

sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
sudo nano /etc/dnsmasq.conf

sudo sysctl -w net.ipv4.ip_forward=1
nano /etc/sysctl.conf
uncomment the line: net.ipv4.ip_forward=1


Set up Firewall Rules (NAT)


sudo nft add table ip nat
sudo nft add chain ip nat POSTROUTING { type nat hook postrouting priority 100 \; }
sudo nft add rule ip nat POSTROUTING oifname "eth0" counter masquerade

sudo systemctl restart dnsmasq
sudo systemctl restart hostapd


export your active NAT
sudo sh -c 'nft list ruleset > /etc/nftables.conf'
sudo systemctl enable nftables


ip addr show wlan0
systemctl status hostapd
systemctl status dnsmasq
sudo nft list ruleset

Assign the IP manually:
sudo ip addr add 192.168.4.1/24 dev wlan0
sudo nmcli con add type ethernet ifname wlan0 ipv4.method manual ipv4.addresses 192.168.4.1/24

sudo journalctl -u dnsmasq -f

sudo rfkill unblock wlan

# 1. Create the static profile
sudo nmcli con add type ethernet con-name wlan0-ap ifname wlan0 ipv4.method manual ipv4.addresses 192.168.4.1/24

# 2. Activate it
sudo nmcli con up wlan0-ap

# 3. Restart dnsmasq so it sees the newly restored IP
sudo systemctl restart dnsmasq

sudo nmcli con add type wifi ifname wlan0 con-name wlan0-ap ssid PiAccessPoint mode ap ipv4.method manual ipv4.addresses 192.168.4.1/24
sudo nmcli con up wlan0-ap

systemctl is-active NetworkManager
sysctl net.ipv4.ip_forward

echo "net.ipv4.ip_forward=1" | sudo tee /etc/sysctl.d/99-ipforward.conf

sudo systemctl is-enabled procps
sudo systemctl enable procps

 nmcli connection show

sudo nano /etc/netplan/Pi4_Config.yaml
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    eth0:
      dhcp4: true
  wifis:
    wlan0:
      dhcp4: false
      addresses:
        - 192.168.4.1/24
      access-points:
        "Pi4_AccessPoint":
          password: "Robot2025"
          mode: ap
      # This is the secret sauce:
      # It tells NetworkManager this is a shared connection
      networkmanager:
        passthrough:
          ipv4.method: shared

# Apply the new Netplan config
sudo netplan apply

# Ensure the IP forward override is also in place for NetworkManager
echo -e "[main]\nip-forward=yes" | sudo tee /etc/NetworkManager/conf.d/ip-forward.conf

# Restart the service
sudo systemctl restart NetworkManager

## NAT configuration
sudo nft list ruleset