services:
  ovos_messagebus:
    image: smartgic/ovos-messagebus:testing
    container_name: ovos_messagebus
    restart: unless-stopped
    network_mode: host                # Required for your current setup
    environment:
      - TZ=Europe/Berlin
      - OVOS_BUS_HOST=127.0.0.1       # Listen on local loopback
    volumes:
      - ~/ovos/config:/home/ovos/.config/mycroft

    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('127.0.0.1', 8181))"]
      interval: 5s
      timeout: 2s
      retries: 5

  ovos_core:
    image: smartgic/ovos-core:testing
    container_name: ovos_core
    restart: unless-stopped
    network_mode: host                # Must match the bus
    environment:
      - TZ=Europe/Berlin
      - OVOS_BUS_HOST=127.0.0.1       # Look for bus on the host's localhost
    volumes:
      - ~/ovos/config:/home/ovos/.config/mycroft
      - ~/ovos/persistence/core:/home/ovos/.local/share/mycroft

  ovos_audio:
    image: smartgic/ovos-audio:testing
    container_name: ovos_audio
    restart: unless-stopped
    network_mode: host
    # 1. Add group permissions
    group_add:
      - audio
    depends_on:
      ovos_messagebus:
        condition: service_healthy
    environment:
      - TZ=Europe/Berlin
      - OVOS_BUS_HOST=127.0.0.1
      # 2. Tell the container to use the host's PulseAudio/PipeWire server
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      #- PIP_INSTALL=ovos-vad-plugin-silero>=0.1.0
      #- PIP_INSTALL=ovos-tts-plugin-phoonnx
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - ~/ovos/config:/home/ovos/.config/mycroft
      - ~/ovos/models/phoonnx:/home/ovos/models/phoonnx:ro
      - ~/ovos/persistence/audio:/home/ovos/.local
      # 3. Map the PulseAudio socket into the container
      - /run/user/1000/pulse:/run/user/1000/pulse
      
  ovos_listener:
    image: smartgic/ovos-listener:testing
    container_name: ovos_listener
    restart: unless-stopped
    network_mode: host                # ADD THIS LINE
    depends_on:
      ovos_messagebus:
        condition: service_healthy
    environment:
      - TZ=Europe/Berlin              # Changed to match your other services
      - OVOS_BUS_HOST=127.0.0.1
      #- PIP_INSTALL=ovos-stt-plugin-fasterwhisper
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - ~/ovos/config:/home/ovos/.config/mycroft
      - ~/ovos/models/whisper:/home/ovos/models/whisper:ro
      - ~/ovos/persistence/listener:/home/ovos/.local