<html class="manual_drive">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="/static/display.css?">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/static/touch-slider.js"></script>
    <title>Forward Drive The Robot</title>
</head>

<body>
    <p id="message"></p>
    <div class="layout">
        <svg id="left_slider" class="slider_track" viewBox="-10 -100 20 200">
            <circle r="18" class="slider_tick"/>
        </svg>

        <div class="content">
            <div class="input-row">
                <div class="input-group">
                    <label for="speed_input">Speed</label>
                    <input type="number" id="speed_input" name="Speed" min="1" max="255" value="100">
                </div>
                <div class="input-group">
                    <label for="distance_input">Distance</label>
                    <input type="number" id="distance_input" name="Distance" min="1" max="10000" value="3000">
                </div>
            </div>
            <div class="button-row">
                <a class="button" id="forwardbutton">Forward</a>
                <a class="button" id="backwardbutton">Backward</a>
                <a class="button" id="stopbutton">Stop</a>
            </div>
            <div class="button-row">
                <a class="button" id="rightbutton">Right</a>
                <a class="button" id="leftbutton">Left</a>
                <a class="button" id="exitbutton">Exit</a>
            </div>
            <div id="video">
                <img id="video-feed" src="http://192.168.4.6:5000/video_feed"/>
            </div>
        </div>

        <svg id="right_slider" class="slider_track" viewBox="-10 -100 20 200">
            <circle r="18" class="slider_tick"/>
        </svg>
    </div>

    <script type="text/javascript">
        function adjustSpeed(speed) {
            return  speed = Math.round(speed * 2.5)
        }

        function set_motor(name) {
           
            const speedInput = document.getElementById("speed_input");
            const distanceInput = document.getElementById("distance_input");
            let speed = parseInt(speedInput.value,10);
            let distance = parseInt(distanceInput.value,10);
            speed = Math.min(255, Math.max(1, speed)); 
            distance = Math.min(10000, Math.max(1, distance));
            
            console.log("set_motor:",name, speed, distance);

            document.getElementById("message").innerHTML = 'set_' + name + '->speed:' + speed + '->distance:' + distance;
            
            $.post('/control',
                {'command':'set_' + name, 'speed': speed, 'distance': distance });}

        function checkServerStatus() {
            fetch("/ping")
                .then(response => {
                    if (!response.ok) throw new Error('Server not OK');
                    setTimeout(checkServerStatus, 5000);
                })
                .catch(error => {
                    console.error("Server down, redirecting:", error);
                    // NOTE: '{{ port }}' is a server-side template placeholder
                    window.location.href = "http://" + window.location.hostname + ":5000/dead_page?port={{ port }}";
                });
        }

        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(checkServerStatus, 5000);

            // Button handlers
            $('#exitbutton').click(function() {
                console.log("exit clicked");
                $.post('/control', { 'command': 'exit' }, () => {
                    setTimeout(() => {
                        // NOTE: '{{ port }}' is a server-side template placeholder
                        window.location.href = "http://" + window.location.hostname + ":5000/dead_page?port={{ port }}";
                    }, 500);
                });
            });

            $('#stopbutton').click(() => set_motor('stop'));
            $('#forwardbutton').click(() => set_motor('forward'));
            $('#backwardbutton').click(() => set_motor('backward'));
            $('#rightbutton').click(() => set_motor('right'));
            $('#leftbutton').click(() => set_motor('left'));

            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case "ArrowUp": set_motor('forward'); break;
                    case "ArrowDown": set_motor('backward'); break;
                    case "ArrowRight": set_motor('right'); break;
                    case "ArrowLeft": set_motor('left'); break;
                    case " ": set_motor('stop', 0); break; // spacebar
                }
            });

            // Optional: auto-refresh video if it's static snapshots
            setInterval(() => {
                const video = document.getElementById("video-feed");
                // NOTE: '{{ url_for('display') }}' is a server-side template placeholder
                video.src = "{{ url_for('display') }}" + "?t=" + new Date().getTime();
            }, 2000);

            // -----------------------------------------------------------------
            // !!! SLIDER INITIALIZATION - CRITICAL FOR SLIDERS TO WORK !!!
            // -----------------------------------------------------------------
            // These calls assume the `makeSlider` function is correctly defined
            // in /static/touch-slider.js
            makeSlider('left_slider', speed => set_motor('forward_left', adjustSpeed(speed)));
            makeSlider('right_slider', speed => set_motor('forward_right', adjustSpeed(speed)));
        });
    </script>
</body>
</html>